
# Cannot filter on the workflow level
master_only: &master_only
  filters:
    branches:
      only: master

version: 2.1
jobs:
  build:
    docker:
      - image: ubuntu:latest
    working_directory: ~/pandas-stubs

    steps:
      - run:
          name: Install Pythons
          command: |
            set -x
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata  # necessary due to https://askubuntu.com/q/909277
            apt-get install -y software-properties-common
            add-apt-repository -y ppa:deadsnakes/ppa
            apt-get update
            apt-get install -y --no-install-recommends python3.6 python3.7 python3.8 python3.9
            apt-get install -y --no-install-recommends python3-pip
      - run:
          name: Install git and ssh
          command: apt-get install -y --no-install-recommends git openssh-client
      - checkout
      - run: pip3 install tox
      - run: tox

  release:
    docker:
      - image: ubuntu:latest
    working_directory: ~/pandas-stubs
    steps:
      - run:
          name: init .pypirc
          <<: *master_only
          command: |
            echo -e "[pypi]" >> ~/.pypirc
            echo -e "username = __token__" >> ~/.pypirc
            echo -e "password = $PYPI_TOKEN" >> ~/.pypirc
      - run:
          name: Install Python
          <<: *master_only
          command: |
            set -x
            apt-get update
            DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata  # necessary due to https://askubuntu.com/q/909277
            apt-get install -y software-properties-common
            add-apt-repository -y ppa:deadsnakes/ppa
            apt-get update
            apt-get install -y --no-install-recommends python3.9
            apt-get install -y --no-install-recommends python3-pip
      - checkout
      - run:
          name: Install twine
          <<: *master_only
          pip3 install twine
      - run:
          name: create packages
          <<: *master_only
          command: |
            python setup.py sdist
            python setup.py bdist_wheel
      - run:
          name: upload to pypi
          <<: *master_only
          command: |
            . venv/bin/activate
            twine upload dist/*

workflows:
  version: 2
  build_and_test:
    jobs:
      - build
  build_test_and_release:
    jobs:
      - build
      - hold:
          type: approval
      - release